<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lecture.lecture_name }} - LectureAI</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
        }
        .main-wrapper {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .navbar {
            flex-shrink: 0;
        }
        .content-wrapper {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .page-title {
            flex-shrink: 0;
            padding: 10px 15px;
        }
        .main-content {
            flex: 1;
            overflow: hidden;
            padding: 15px;
        }
        .main-content .row {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            flex-wrap: nowrap;
        }
        .main-content .row > [class*="col-"] {
            flex-shrink: 0;
            min-width: 320px;
        }
        .main-content .row::-webkit-scrollbar {
            height: 8px;
        }
        .main-content .row::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .main-content .row::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        .main-content .row::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .card {
            height: 100%;
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }
        @media (max-width: 991.98px) {
            html, body {
                overflow: auto;
            }
            .main-wrapper {
                min-height: 100vh;
                height: auto;
            }
            .content-wrapper {
                overflow: visible;
            }
            .main-content {
                overflow: visible;
                padding: 15px;
            }
            .main-content .row {
                overflow-x: visible;
                overflow-y: visible;
                flex-wrap: wrap;
                height: auto !important;
            }
            .main-content .row > [class*="col-"] {
                flex-shrink: 1;
                min-width: 100%;
                width: 100%;
                height: auto;
                margin-bottom: 15px;
            }
            /* 작은 화면에서 순서 변경: PDF(1) → 요약본(2) → 스크립트(3) → RAG(4) */
            .main-content .row > .col-lg-4:nth-child(1) {
                order: 1; /* PDF - 강의 자료 */
            }
            .main-content .row > .col-lg-4:nth-child(2) {
                order: 3; /* 중앙 - 스크립트+RAG */
            }
            .main-content .row > .col-lg-4:nth-child(3) {
                order: 2; /* 요약본 */
            }
            /* PDF 카드 고정 높이 */
            .main-content .row > .col-lg-4:nth-child(1) .card {
                height: 500px !important;
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(1) .card-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(1) #pdf-container {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                height: 0;
            }
            /* 요약본 카드 고정 높이 */
            .main-content .row > .col-lg-4:nth-child(3) .card {
                height: 400px !important;
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(3) .card-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(3) .summary-container {
                flex: 1;
                overflow-y: auto;
                height: 0;
            }
            /* 중앙 컬럼 (스크립트+RAG) 세로 배치 */
            .middle-column {
                flex-direction: column;
                height: auto !important;
            }
            .main-content .row > .col-lg-4:nth-child(2) .script-card {
                order: 1;
                height: calc(100vh - 200px) !important;
                min-height: 600px;
                max-height: 1200px;
                margin-bottom: 15px;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .script-card .card-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .script-card .script-container {
                flex: 1;
                overflow: hidden;
                height: 0;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .script-card .script-container textarea {
                flex: 1;
                width: 100%;
                min-height: 100%;
                overflow-y: auto;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card {
                order: 2;
                height: calc(100vh - 200px) !important;
                min-height: 600px;
                max-height: 1200px;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card .card-body {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card .rag-container {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card .rag-container {
                flex: 1;
                overflow: hidden;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card #chat-container {
                flex: 1;
                overflow-y: auto;
                overflow-x: hidden;
                height: 0;
                min-height: 0;
            }
            .main-content .row > .col-lg-4:nth-child(2) .rag-card .chat-form-wrapper {
                flex-shrink: 0;
            }
            /* 일반 카드 높이 */
            .card {
                height: auto;
                min-height: auto;
            }
        }
        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #pdf-container {
            overflow-y: auto;
            overflow-x: hidden;
            background-color: #f8f9fa;
            flex: 1;
            padding: 5px 2px 5px 2px;
        }
        .pdf-page-wrapper {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .pdf-page-number {
            flex-shrink: 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 500;
            padding-top: 5px;
            min-width: 20px;
            text-align: right;
            padding-right: 3px;
        }
        .pdf-page-wrapper canvas {
            flex: 1;
            max-width: 100%;
            height: auto;
            display: block;
        }
        .pdf-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pdf-loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        .script-container {
            flex: 1;
            overflow: hidden;
            margin-bottom: 10px;
            padding: 0;
            background-color: #f8f9fa;
            border-radius: 0.375rem;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        .script-container textarea {
            width: 100%;
            flex: 1;
            min-height: 100%;
            font-family: monospace;
            resize: none;
            border: none;
            background-color: transparent;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .rag-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        #chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 15px;
            background-color: #f8f9fa;
            margin-bottom: 10px;
        }
        .chat-form-wrapper {
            flex-shrink: 0;
        }
        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 0.375rem;
        }
        .chat-message.user {
            background-color: #e7f3ff;
        }
        .chat-message.assistant {
            background-color: #ffffff;
        }
        .chat-message.assistant .markdown-content {
            line-height: 1.6;
        }
        .chat-message.assistant .markdown-content h1,
        .chat-message.assistant .markdown-content h2,
        .chat-message.assistant .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
        }
        .chat-message.assistant .markdown-content h1 {
            font-size: 1.5em;
        }
        .chat-message.assistant .markdown-content h2 {
            font-size: 1.3em;
        }
        .chat-message.assistant .markdown-content h3 {
            font-size: 1.1em;
        }
        .chat-message.assistant .markdown-content p {
            margin-bottom: 0.8em;
        }
        .chat-message.assistant .markdown-content ul,
        .chat-message.assistant .markdown-content ol {
            margin-bottom: 0.8em;
            padding-left: 1.5em;
        }
        .chat-message.assistant .markdown-content li {
            margin-bottom: 0.3em;
        }
        .chat-message.assistant .markdown-content code {
            background-color: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .chat-message.assistant .markdown-content pre {
            background-color: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin-bottom: 0.8em;
        }
        .chat-message.assistant .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }
        .chat-message.assistant .markdown-content blockquote {
            border-left: 4px solid #ddd;
            padding-left: 1em;
            margin-left: 0;
            color: #666;
            margin-bottom: 0.8em;
        }
        .chat-message.assistant .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.8em;
        }
        .chat-message.assistant .markdown-content table th,
        .chat-message.assistant .markdown-content table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .chat-message.assistant .markdown-content table th {
            background-color: #f4f4f4;
            font-weight: 600;
        }
        .summary-container {
            overflow-y: auto;
            height: 100%;
        }
        .middle-column {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .script-card {
            flex: 1;
            margin-bottom: 10px;
        }
        .rag-card {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
            <div class="container-fluid">
                <a class="navbar-brand" href="{% url 'upload' %}">
                    <i class="bi bi-mortarboard-fill"></i> LectureAI
                </a>
                <a href="{% url 'upload' %}" class="btn btn-light">
                    <i class="bi bi-arrow-left"></i> 업로드 페이지로 돌아가기
                </a>
            </div>
        </nav>

        <div class="content-wrapper">
            <div class="page-title">
                <h5 class="mb-0">
                    <i class="bi bi-book"></i> {{ lecture.lecture_name }}
                </h5>
            </div>

            <div class="container-fluid main-content">
                <div class="row g-2 h-100">
                    <!-- PDF 뷰어 컬럼 -->
                    <div class="col-lg-4 h-100">
                        <div class="card h-100">
                            <div class="card-header bg-info text-white pdf-card-header">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-file-earmark-pdf"></i> 강의 자료 (PDF)
                                </h6>
                                <a href="{{ lecture.pdf_file.url }}" target="_blank" class="btn btn-sm btn-light">
                                    <i class="bi bi-box-arrow-up-right"></i> 새 창에서 열기
                                </a>
                            </div>
                            <div class="card-body p-0">
                                <div id="pdf-container">
                                    <div class="pdf-loading">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">로딩 중...</span>
                                        </div>
                                        <p class="mt-2">PDF를 로드하는 중...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 중앙 컬럼: 스크립트(상단) + RAG(하단) -->
                    <div class="col-lg-4 h-100">
                        <div class="middle-column">
                            <!-- 스크립트 카드 (상단 절반) -->
                            <div class="card script-card">
                                <div class="card-header bg-success text-white">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-file-text"></i> 음성 스크립트 (STT)
                                    </h6>
                                </div>
                                <div class="card-body">
                                <div class="script-container">
                                    <textarea class="form-control" disabled>{{ lecture.full_script }}</textarea>
                                </div>
                            </div>
                            </div>

                            <!-- RAG 카드 (하단 절반) -->
                            <div class="card rag-card">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="card-title mb-0">
                                        <i class="bi bi-chat-dots"></i> AI 질의응답 (RAG)
                                    </h6>
                                </div>
                                <div class="card-body rag-container">
                                    <div id="chat-container"></div>
                                    <div class="chat-form-wrapper">
                                        <form id="chat-form" data-lecture-id="{{ lecture.id }}">
                                            <div class="input-group input-group-sm">
                                                <input type="text" class="form-control" id="chat-input" placeholder="강의 내용에 대해 질문해 주세요...">
                                                <button type="submit" class="btn btn-primary">
                                                    <i class="bi bi-send"></i> 전송
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 요약본 컬럼 -->
                    <div class="col-lg-4 h-100">
                        <div class="card h-100">
                            <div class="card-header bg-secondary text-white">
                                <h6 class="card-title mb-0">
                                    <i class="bi bi-list-check"></i> 소주제별 요약본
                                </h6>
                            </div>
                            <div class="card-body summary-container">
                                {% if summary_list %}
                                    <div class="accordion" id="summaryAccordion">
                                        {% for item in summary_list %}
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                                    <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                                                        {{ item.topic }}
                                                        {% if item.timestamp %}
                                                            <span class="badge bg-success ms-2">{{ item.timestamp }}</span>
                                                        {% endif %}
                                                        {% if item.mapped_page %}
                                                            <span class="badge bg-info ms-2">PDF {{ item.mapped_page }}p</span>
                                                        {% endif %}
                                                    </button>
                                                </h2>
                                                <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#summaryAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>요약:</strong> {{ item.summary }}</p>
                                                        <small class="text-muted">원본 구간: {{ item.original_segment }}</small>
                                                    </div>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-muted text-center">요약 정보가 없습니다.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF.js 라이브러리 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked.js 라이브러리 로드 (마크다운 파싱) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // PDF.js 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const pdfUrl = "{{ lecture.pdf_file.url }}";
        const pdfContainer = document.getElementById('pdf-container');
        const scale = 1.5;
        
        // PDF 로드 및 모든 페이지 렌더링
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdfDoc) {
            const numPages = pdfDoc.numPages;
            
            // 로딩 메시지 제거
            pdfContainer.innerHTML = '';
            
            // 모든 페이지를 순차적으로 렌더링하는 함수
            function renderAllPages() {
                const renderPromises = [];
                
                // 모든 페이지 렌더링 작업을 배열에 저장
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    renderPromises.push(
                        pdfDoc.getPage(pageNum).then(function(page) {
                            return new Promise(function(resolve) {
                                // 페이지 래퍼 생성
                                const pageWrapper = document.createElement('div');
                                pageWrapper.className = 'pdf-page-wrapper';
                                pageWrapper.id = `pdf-page-${pageNum}`;
                                
                                // Canvas 생성
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // 뷰포트 계산
                                const viewport = page.getViewport({scale: scale});
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                // 페이지 번호 표시 (왼쪽에 배치, 숫자만)
                                const pageNumber = document.createElement('div');
                                pageNumber.className = 'pdf-page-number';
                                pageNumber.textContent = pageNum;
                                
                                // 렌더링
                                const renderContext = {
                                    canvasContext: ctx,
                                    viewport: viewport
                                };
                                
                                page.render(renderContext).promise.then(function() {
                                    // 페이지 번호를 먼저 추가 (왼쪽)
                                    pageWrapper.appendChild(pageNumber);
                                    // 그 다음 canvas 추가 (오른쪽)
                                    pageWrapper.appendChild(canvas);
                                    resolve({pageNum: pageNum, element: pageWrapper});
                                });
                            });
                        })
                    );
                }
                
                // 모든 페이지가 렌더링된 후 순서대로 추가
                Promise.all(renderPromises).then(function(pages) {
                    // 페이지 번호 순으로 정렬
                    pages.sort(function(a, b) {
                        return a.pageNum - b.pageNum;
                    });
                    
                    // 순서대로 DOM에 추가
                    pages.forEach(function(page) {
                        pdfContainer.appendChild(page.element);
                    });
                });
            }
            
            renderAllPages();
        }).catch(function(error) {
            console.error('PDF 로드 오류:', error);
            pdfContainer.innerHTML = 
                '<div class="alert alert-danger m-3" role="alert">PDF를 로드할 수 없습니다. <a href="' + pdfUrl + '" target="_blank" class="alert-link">여기를 클릭하여 새 창에서 열기</a></div>';
        });
    </script>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const lectureId = parseInt(chatForm.dataset.lectureId);
        
        // localStorage 키 생성
        const chatStorageKey = `chat_history_${lectureId}`;
        
        // 채팅 기록 저장 함수
        function saveChatHistory() {
            const messages = [];
            chatContainer.querySelectorAll('.chat-message').forEach(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.innerHTML;
                messages.push({
                    type: isUser ? 'user' : 'assistant',
                    content: content
                });
            });
            localStorage.setItem(chatStorageKey, JSON.stringify(messages));
        }
        
        // 채팅 기록 불러오기 함수
        function loadChatHistory() {
            const saved = localStorage.getItem(chatStorageKey);
            if (saved) {
                try {
                    const messages = JSON.parse(saved);
                    messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.type}`;
                        messageDiv.innerHTML = msg.content;
                        chatContainer.appendChild(messageDiv);
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } catch (e) {
                    console.error('채팅 기록 로드 오류:', e);
                }
            }
        }
        
        // 페이지 로드 시 채팅 기록 불러오기
        loadChatHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userMessage = chatInput.value;
            if (!userMessage) return;

            // 1. 사용자 메시지 UI에 표시
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user';
            userMessageDiv.innerHTML = `<strong><i class="bi bi-person-fill"></i> 나:</strong> ${userMessage}`;
            chatContainer.appendChild(userMessageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 사용자 메시지 저장
            saveChatHistory();
            
            chatInput.value = '';
            chatInput.disabled = true;

            // 2. 로딩 표시
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<strong><i class="bi bi-robot"></i> AI:</strong> <span class="spinner-border spinner-border-sm" role="status"></span> 답변을 생성하는 중...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // 3. Django API에 Fetch 요청
                const response = await fetch("{% url 'api_chat' %}", {
                    method: 'POST',
                    body: JSON.stringify({
                        'lecture_id': lectureId,
                        'query_text': userMessage
                    }),
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                // 4. 로딩 메시지 제거
                loadingDiv.remove();

                // 5. AI 답변 UI에 표시 (마크다운 렌더링)
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'chat-message assistant';
                
                // 마크다운을 HTML로 변환
                const markdownContent = marked.parse(data.content);
                
                aiMessageDiv.innerHTML = `
                    <strong><i class="bi bi-robot"></i> AI:</strong>
                    <div class="markdown-content">${markdownContent}</div>
                `;
                chatContainer.appendChild(aiMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // AI 답변 저장
                saveChatHistory();
            } catch (error) {
                loadingDiv.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant alert alert-danger';
                errorDiv.innerHTML = `<strong><i class="bi bi-exclamation-triangle"></i> 오류:</strong> ${error.message}`;
                chatContainer.appendChild(errorDiv);
                saveChatHistory();
            } finally {
                chatInput.disabled = false;
                chatInput.focus();
            }
        });
    </script>
</body>
</html>
