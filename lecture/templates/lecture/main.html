{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lecture.lecture_name }} - LectureAI</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- 전역 다크 모드 CSS -->
    <link href="{% static 'lecture/css/dark-theme.css' %}" rel="stylesheet">
    <style>
        /* 이미지 기반 색상 팔레트 */
        :root {
            --bg-primary: #37383B;
            --bg-secondary: #1A1A1A;
            --bg-card: #22262B;
            --bg-header: #252525;
            --text-primary: #E0E0E0;
            --text-secondary: #B0B0B0;
            --border-color: #2A2A2A;
            --border-radius: 16px;
        }
        
        /* 레이아웃 구조 */
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            padding: 0;
            background-color: var(--bg-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        
        .main-wrapper {
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
        }
        
        /* 상단 헤더 */
        .top-header {
            flex-shrink: 0;
            background-color: #37383B;
            border-bottom: none;
            padding: 14px 20px 8px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .top-header h4 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 1.625rem;
            display: flex;
            align-items: center;
        }
        
        .top-header h4 i {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        
        /* 로고 원형 스타일 */
        .top-header-logo {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
        }
        
        /* 로고 링크 스타일 */
        .top-header h4 a {
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }
        
        .top-header h4 a:hover {
            opacity: 0.8;
        }
        
        .top-header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .download-section {
            display: inline-flex;
            align-items: center;
            gap: 0;
            cursor: default;
        }
        
        .download-section.btn-sm {
            padding: 0.25rem 0.5rem;
        }
        
        .download-section:hover {
            background-color: #F0F0F0;
            border-color: #F0F0F0;
        }
        
        .download-icon {
            color: #000000;
            font-size: 1rem;
            margin-right: 0px;
            pointer-events: none;
        }
        
        .download-label {
            color: #22262B;
            font-size: 0.875rem;
            padding: 0 8px;
            user-select: none;
            pointer-events: none;
        }
        
        .download-divider {
            width: 1px;
            height: 20px;
            background-color: #CCCCCC;
            margin: 0 4px;
            flex-shrink: 0;
        }
        
        .download-link-inner {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 8px;
            color: #22262B;
            text-decoration: none;
            transition: opacity 0.2s ease;
        }
        
        .download-link-inner:hover {
            opacity: 0.7;
            color: #22262B;
        }
        
        .download-link-inner i {
            color: #000000;
            font-size: 1rem;
        }
        
        .top-header-actions .btn {
            background-color: #FFFFFF;
            border-color: #FFFFFF;
            color: #22262B;
        }
        
        .top-header-actions .btn:hover {
            background-color: #F0F0F0;
            border-color: #F0F0F0;
            color: #22262B;
        }
        
        /* 메인 콘텐츠 영역 (3분할 레이아웃) */
        .main-content-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            gap: 17px;
            padding: 5px 17px 18px 17px;
            min-height: 0;
        }
        
        /* 각 컬럼 공통 스타일 */
        .content-column {
            display: flex;
            flex-direction: column;
            min-width: 0;
            transition: all 0.3s ease;
        }
        
        .content-column.collapsed {
            flex: 0 0 50px;
            min-width: 50px;
            overflow: visible;
        }
        
        .content-column.collapsed .content-card-body {
            display: none;
        }
        
        .content-column.collapsed .content-card-header {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            padding: 8px 8px 16px 8px;
            height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            position: relative;
        }
        
        .content-column.collapsed .content-card-header h6 {
            transform: rotate(180deg);
            white-space: nowrap;
            color: var(--text-primary);
            margin: 0;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%) rotate(180deg);
        }
        
        .content-column.collapsed .content-card-header h6 i {
            display: none;
        }
        
        .content-column.collapsed .content-card-header-actions {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            flex-direction: row;
            gap: 4px;
            z-index: 10;
        }
        
        .content-column.collapsed .content-card-header-actions .btn-group {
            display: none;
        }
        
        .content-column.collapsed .content-card-header-actions a[target="_blank"] {
            display: none;
        }
        
        .content-column.collapsed .content-card {
            cursor: pointer;
        }
        
        .content-column.collapsed .content-card:hover {
            background-color: var(--bg-hover);
        }
        
        .content-column.expanded {
            flex: 1;
        }
        
        /* Lecture note 컬럼 (왼쪽) */
        .lecture-note-column {
            flex: 1;
        }
        
        /* Script 컬럼 (중앙) */
        .script-column {
            flex: 1.3;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .script-column .content-card {
            flex: 1;
            min-height: 0;
        }
        
        /* Summary 컬럼 (오른쪽) */
        .summary-column {
            flex: 1;
        }
        
        /* 카드 스타일 - 이미지 기반 디자인 */
        .content-card {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-card);
            border: none;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .content-card-header {
            flex-shrink: 0;
            background-color: var(--bg-card);
            border-bottom: 1px solid #37383B;
            padding: 14px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 48px;
            height: 48px;
        }
        
        .content-card-header h6 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .content-card-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .content-card-header-actions .btn-group {
            display: flex;
            align-items: center;
            height: 100%;
        }
        
        .content-card-header-actions .btn-group .btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 6px 12px;
            height: auto;
        }
        
        .content-card-body {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: var(--bg-card);
        }
        
        /* PDF 컨테이너 */
        #pdf-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            background-color: var(--bg-card);
            padding: 10px;
        }
        
        .pdf-page-wrapper {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        
        .pdf-page-number {
            flex-shrink: 0;
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 500;
            padding-top: 5px;
            min-width: 20px;
            text-align: right;
            padding-right: 3px;
        }
        
        .pdf-page-wrapper canvas {
            flex: 1;
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .pdf-loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Script 컨테이너 */
        .script-container {
            flex: 1;
            overflow: hidden;
            background-color: #22262B;
            display: flex;
            flex-direction: column;
        }
        
        .script-container textarea {
            width: 100%;
            flex: 1;
            min-height: 100%;
            font-family: 'Courier New', monospace;
            resize: none;
            border: none;
            background-color: #22262B !important;
            color: #C1C1C1 !important;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .script-container textarea.form-control {
            background-color: #22262B !important;
            color: #C1C1C1 !important;
        }
        
        .script-container textarea:disabled {
            background-color: #22262B !important;
            color: #C1C1C1 !important;
            -webkit-text-fill-color: #C1C1C1 !important;
        }
        
        #script-textarea {
            background-color: #22262B !important;
            color: #C1C1C1 !important;
        }
        
        #script-textarea.form-control {
            background-color: #22262B !important;
        }
        
        #script-textarea.form-control:disabled {
            background-color: #22262B !important;
            color: #C1C1C1 !important;
            -webkit-text-fill-color: #C1C1C1 !important;
        }
        
        /* Summary 컨테이너 */
        .summary-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            background-color: var(--bg-card);
        }
        
        /* AI Assistant (Script 컬럼 내부) */
        .ai-assistant-section {
            flex: 1;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            min-height: 0;
            border-radius: var(--border-radius);
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        
        .ai-assistant-header {
            flex-shrink: 0;
            background-color: var(--bg-card);
            border-bottom: 1px solid #37383B;
            padding: 8px 16px;
            min-height: 48px;
            height: 48px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
        }
        
        .ai-assistant-header h6 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            line-height: 1.2;
        }
        
        .ai-assistant-header p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.7rem;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .rag-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 10px;
            min-height: 0;
        }
        
        #chat-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #37383B;
            border-radius: var(--border-radius);
            padding: 15px;
            background-color: var(--bg-card);
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-form-wrapper {
            flex-shrink: 0;
            border: 1px solid #37383B;
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: var(--bg-card);
        }
        
        .chat-form-wrapper .form-control {
            border-color: #37383B;
        }
        
        .chat-form-wrapper .form-control:focus {
            border-color: #37383B;
        }
        
        .chat-message {
            margin-bottom: 15px;
        }
        
        .chat-message.user {
            background-color: #1A1D22;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            border-bottom-right-radius: 0;
            margin-left: 40px;
            margin-right: 0;
            align-self: flex-end;
            max-width: 80%;
            color: var(--text-primary);
        }
        
        .chat-message.assistant {
            background-color: transparent;
            padding: 0;
            border: none;
            margin-left: 0;
            margin-right: 0;
        }
        
        /* 알림 스타일 */
        .alert {
            background-color: var(--bg-header);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            color: var(--text-primary);
        }
        
        .alert-info {
            background-color: var(--bg-header);
            border-color: #4A90E2;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content {
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content h1,
        .chat-message.assistant .markdown-content h2,
        .chat-message.assistant .markdown-content h3 {
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content h1 {
            font-size: 1.5em;
        }
        
        .chat-message.assistant .markdown-content h2 {
            font-size: 1.3em;
        }
        
        .chat-message.assistant .markdown-content h3 {
            font-size: 1.1em;
        }
        
        .chat-message.assistant .markdown-content p {
            margin-bottom: 0.8em;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content ul,
        .chat-message.assistant .markdown-content ol {
            margin-bottom: 0.8em;
            padding-left: 1.5em;
        }
        
        .chat-message.assistant .markdown-content li {
            margin-bottom: 0.3em;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content code {
            background-color: var(--bg-header);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #4A90E2;
        }
        
        .chat-message.assistant .markdown-content pre {
            background-color: var(--bg-header);
            padding: 10px;
            border-radius: var(--border-radius);
            overflow-x: auto;
            margin-bottom: 0.8em;
            border: 1px solid var(--border-color);
        }
        
        .chat-message.assistant .markdown-content pre code {
            background-color: transparent;
            padding: 0;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content blockquote {
            border-left: 4px solid #4A90E2;
            padding-left: 1em;
            margin-left: 0;
            color: var(--text-secondary);
            margin-bottom: 0.8em;
        }
        
        .chat-message.assistant .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 0.8em;
        }
        
        .chat-message.assistant .markdown-content table th,
        .chat-message.assistant .markdown-content table td {
            border: 1px solid var(--border-color);
            padding: 8px;
            text-align: left;
        }
        
        .chat-message.assistant .markdown-content table th {
            background-color: var(--bg-header);
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .chat-message.assistant .markdown-content table td {
            color: var(--text-primary);
        }
        
        /* 버튼 스타일 - Bootstrap 덮어쓰기 */
        .btn {
            border-radius: var(--border-radius);
            font-weight: 500;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
            background-color: var(--bg-card);
            color: var(--text-primary);
        }
        
        .btn:hover {
            background-color: var(--bg-header);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-primary {
            background-color: #4A90E2;
            border-color: #4A90E2;
            color: #FFFFFF;
        }
        
        .btn-primary:hover {
            background-color: #357ABD;
            border-color: #357ABD;
            color: #FFFFFF;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.875rem;
        }
        
        .btn-light {
            background-color: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .btn-light:hover {
            background-color: var(--bg-header);
            border-color: var(--border-color);
            color: var(--text-primary);
        }
        
        .download-link {
            background-color: #FFFFFF !important;
            border-color: #FFFFFF !important;
            color: #22262B !important;
        }
        
        .download-link:hover {
            background-color: #F0F0F0 !important;
            border-color: #FFFFFF !important;
            color: #22262B !important;
        }
        
        .download-link i {
            color: #000000 !important;
        }
        
        .download-link:hover i {
            color: #000000 !important;
        }
        
        /* 입력 필드 스타일 */
        .form-control {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: var(--border-radius);
            padding: 8px 12px;
        }
        
        .form-control:focus {
            background-color: var(--bg-card);
            border-color: #4A90E2;
            color: var(--text-primary);
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
        }
        
        .form-control::placeholder {
            color: var(--text-secondary);
        }
        
        .chat-input-group {
            display: flex;
            gap: 8px;
        }
        
        .chat-input-group input {
            flex: 1;
        }
        
        .chat-input-group button {
            flex-shrink: 0;
        }
        
        /* 접기/펴기 버튼 아이콘 */
        .collapse-toggle-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: var(--border-radius);
        }
        
        .collapse-toggle-btn:hover {
            background-color: var(--bg-header);
            border-color: var(--border-color);
        }
        
        .collapse-toggle-btn i {
            transition: transform 0.3s ease;
        }
        
        .collapse-toggle-btn.collapsed i.bi-chevron-left {
            transform: rotate(180deg);
        }
        
        .collapse-toggle-btn.collapsed i.bi-chevron-right {
            transform: rotate(180deg);
        }
        
        /* 아코디언 스타일 */
        .accordion {
            --bs-accordion-border-color: #37383B;
            --bs-accordion-border-radius: var(--border-radius);
            --bs-accordion-border-width: 0;
        }
        
        .accordion-item {
            background-color: var(--bg-card);
            border: 1px solid #37383B !important;
            border-radius: var(--border-radius) !important;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .accordion-item + .accordion-item {
            border-top: 1px solid #37383B !important;
        }
        
        .accordion-button {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border: none !important;
            border-radius: var(--border-radius) !important;
            padding: 12px 16px;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            width: 100%;
            gap: 16px;
        }
        
        .accordion-button-title {
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .accordion-button-badges {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            width: 150px;
            justify-content: flex-end;
            min-width: 150px;
        }
        
        .accordion-button-badges .badge {
            margin: 0 !important;
            flex-shrink: 0;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
        }
        
        .accordion-button-badges .badge.bg-success {
            min-width: 60px;
            width: 60px;
            text-align: center;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .accordion-button-badges .badge.bg-info {
            min-width: 70px;
            width: 70px;
            text-align: center;
            padding-left: 8px;
            padding-right: 8px;
        }
        
        .accordion-button::after {
            display: none !important;
        }
        
        .accordion-button:not(.collapsed) {
            background-color: var(--bg-card);
            color: var(--text-primary);
            box-shadow: none;
            border-bottom: 1px solid #37383B !important;
            border-radius: var(--border-radius) var(--border-radius) 0 0 !important;
        }
        
        .accordion-button:not(.collapsed)::after {
            display: none !important;
        }
        
        .accordion-button.collapsed {
            border-radius: var(--border-radius) !important;
        }
        
        .accordion-button:focus {
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
            border-color: #4A90E2;
        }
        
        .accordion-collapse {
            border: none;
        }
        
        .accordion-body {
            background-color: var(--bg-card);
            color: var(--text-primary);
            padding: 12px 16px;
            border-bottom-left-radius: var(--border-radius);
            border-bottom-right-radius: var(--border-radius);
        }
        
        /* 배지 스타일 */
        .badge {
            background-color: var(--bg-header);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 500;
        }
        
        .badge.bg-success {
            background-color: #4CAF50 !important;
            color: #FFFFFF !important;
        }
        
        .badge.bg-info {
            background-color: #4A90E2 !important;
            color: #FFFFFF !important;
        }
        
        /* 반응형 디자인 */
        @media (max-width: 991.98px) {
            .main-content-area {
                flex-direction: column;
                overflow-y: auto;
            }
            
            .content-column {
                flex: 1 1 auto;
                min-height: 400px;
            }
            
            .content-column.collapsed {
                flex: 0 0 50px;
                min-height: 50px;
            }
            
            .content-column.collapsed .content-card-header {
                writing-mode: vertical-rl;
                text-orientation: mixed;
                padding: 8px 8px 16px 8px;
                height: 100%;
                justify-content: center;
                align-items: center;
                flex-direction: column;
                position: relative;
            }
            
            .content-column.collapsed .content-card-header h6 {
                transform: translate(-50%, -50%) rotate(180deg);
                position: absolute;
                left: 50%;
                top: 50%;
            }
            
            .content-column.collapsed .content-card-header h6 i {
                display: none;
            }
            
            .content-column.collapsed .content-card-header-actions {
                position: absolute;
                top: 8px;
                left: 50%;
                transform: translateX(-50%);
                flex-direction: row;
            }
            
            .content-column.collapsed .content-card-header-actions a[target="_blank"] {
                display: none;
            }
            
            .ai-assistant-section {
                min-height: 250px;
                max-height: none;
            }
            
            .rag-container {
                min-height: 200px;
            }
        }
        
        @media (max-width: 575.98px) {
            .top-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }
            
            .top-header-actions {
                width: 100%;
                justify-content: space-between;
            }
            
            .rag-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <!-- 상단 헤더 -->
        <div class="top-header">
            <h4><a href="{% url 'upload' %}"><img src="{% static 'lecture/images/icon10.png' %}" alt="ReLec Logo" class="top-header-logo"></a> {{ lecture.lecture_name }}</h4>
            <div class="top-header-actions">
                <div class="download-section btn btn-light btn-sm">
                    <i class="bi bi-download download-icon"></i>
                    <span class="download-label">다운로드</span>
                    <span class="download-divider"></span>
                    <a href="{% url 'download_summary' lecture.id %}" class="download-link-inner" data-download-type="summary" title="요약 파일 다운로드">
                        <i class="bi bi-list-check"></i>
                    </a>
                    <span class="download-divider"></span>
                    <a href="{% url 'download_script' lecture.id %}" class="download-link-inner" data-download-type="script" title="스크립트 파일 다운로드">
                        <i class="bi bi-file-text"></i>
                    </a>
                </div>
                <button id="share-link-btn" class="btn btn-light btn-sm" title="공유하기">
                    <i class="bi bi-link-45deg"></i> 공유하기
                </button>
                <a href="{% url 'upload' %}" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-left"></i> 업로드 페이지로 돌아가기
                </a>
            </div>
        </div>

        <!-- 메인 콘텐츠 영역 (3분할 레이아웃) -->
        <div class="main-content-area">
            <!-- Lecture note 컬럼 (왼쪽) -->
            <div class="content-column lecture-note-column" id="lecture-note-column">
                <div class="content-card">
                    <div class="content-card-header">
                        <h6><i class="bi bi-file-earmark-pdf"></i> Lecture note</h6>
                        <div class="content-card-header-actions">
                            <a href="{{ lecture.pdf_file.url }}" target="_blank" class="btn btn-sm btn-light" title="새 창에서 열기">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                            <button class="btn btn-sm collapse-toggle-btn" id="toggle-lecture-note" title="접기/펴기">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content-card-body" id="lecture-note-body">
                        <div id="pdf-container">
                            <div class="pdf-loading">
                                <div class="spinner-border spinner-border-sm text-primary" role="status">
                                    <span class="visually-hidden">로딩 중...</span>
                                </div>
                                <p class="mt-2">PDF를 로드하는 중...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Script 컬럼 (중앙) - Script + AI Assistant -->
            <div class="content-column script-column" id="script-column">
                <div class="content-card">
                    <div class="content-card-header">
                        <h6><i class="bi bi-file-text"></i> Script</h6>
                    </div>
                    <div class="content-card-body">
                        <div class="script-container">
                            <textarea id="script-textarea" class="form-control" disabled>{{ lecture.full_script }}</textarea>
                        </div>
                    </div>
                </div>
                <!-- AI Assistant 섹션 -->
                <div class="ai-assistant-section">
                    <div class="ai-assistant-header">
                        <h6><i class="bi bi-chat-dots"></i> AI Assistant</h6>
                        <p>Ask questions about your uploaded materials or anything else</p>
                    </div>
                    <div class="rag-container">
                        <div id="chat-container">
                            {% if not is_owner %}
                            <div class="alert alert-info mb-0" role="alert">
                                <i class="bi bi-info-circle"></i> 강의 소유자만 RAG 질의응답을 사용할 수 있습니다.
                            </div>
                            {% endif %}
                        </div>
                        <div class="chat-form-wrapper">
                            <form id="chat-form" data-lecture-id="{{ lecture.id }}">
                                <div class="chat-input-group">
                                    <input type="text" class="form-control" id="chat-input" placeholder="Ask a question..." {% if not is_owner %}disabled{% endif %}>
                                    <button type="submit" class="btn btn-primary" {% if not is_owner %}disabled{% endif %}>
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary 컬럼 (오른쪽) -->
            <div class="content-column summary-column" id="summary-column">
                <div class="content-card">
                    <div class="content-card-header">
                        <h6><i class="bi bi-list-check"></i> Summary</h6>
                        <div class="content-card-header-actions">
                            <button class="btn btn-sm collapse-toggle-btn" id="toggle-summary" title="접기/펴기">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    <div class="content-card-body" id="summary-body">
                        <div class="summary-container">
                            {% if summary_list %}
                                <div class="accordion" id="summaryAccordion">
                                    {% for item in summary_list %}
                                        <div class="accordion-item">
                                            <h2 class="accordion-header" id="heading{{ forloop.counter }}">
                                                <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ forloop.counter }}" aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}">
                                                    <span class="accordion-button-title">{{ item.topic }}</span>
                                                    <span class="accordion-button-badges">
                                                        {% if item.timestamp %}
                                                            <span class="badge bg-success">{{ item.timestamp }}</span>
                                                        {% endif %}
                                                        {% if item.mapped_page %}
                                                            <span class="badge bg-info">PDF {{ item.mapped_page }}p</span>
                                                        {% endif %}
                                                    </span>
                                                </button>
                                            </h2>
                                            <div id="collapse{{ forloop.counter }}" class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" aria-labelledby="heading{{ forloop.counter }}" data-bs-parent="#summaryAccordion">
                                                <div class="accordion-body">
                                                    <p><strong>요약:</strong> {{ item.summary }}</p>
                                                    <small class="text-muted">원본 구간: {{ item.original_segment }}</small>
                                                </div>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <p class="text-muted text-center">요약 정보가 없습니다.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF.js 라이브러리 로드 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- Marked.js 라이브러리 로드 (마크다운 파싱) -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Bootstrap 5 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // 스크립트 포맷팅: 각 타임스탬프마다 줄바꿈 추가
        function formatScriptWithTimestamps(scriptText) {
            if (!scriptText || scriptText.trim() === '') {
                return scriptText;
            }
            
            // 타임스탬프 패턴: [MM:SS] 또는 [MM:SS - MM:SS]
            const timestampPattern = /\[(\d{2}):(\d{2})(?:\s*-\s*(\d{2}):(\d{2}))?\]/g;
            
            // 모든 타임스탬프의 위치 찾기
            const matches = [];
            let match;
            while ((match = timestampPattern.exec(scriptText)) !== null) {
                matches.push({
                    index: match.index,
                    text: match[0]
                });
            }
            
            // 타임스탬프가 없으면 원본 반환
            if (matches.length === 0) {
                return scriptText;
            }
            
            // 각 타임스탬프를 기준으로 텍스트 분할하고 줄바꿈 추가
            let result = '';
            for (let i = 0; i < matches.length; i++) {
                const currentMatch = matches[i];
                const nextIndex = (i < matches.length - 1) ? matches[i + 1].index : scriptText.length;
                
                // 현재 타임스탬프부터 다음 타임스탬프 전까지의 텍스트 추출
                const segment = scriptText.substring(currentMatch.index, nextIndex);
                
                // 첫 번째가 아니면 줄바꿈 추가
                if (i > 0) {
                    result += '\n';
                }
                
                result += segment;
            }
            
            // 타임스탬프 뒤의 공백을 줄바꿈으로 변경 (가독성 향상)
            result = result.replace(/\]\s+/g, ']\n');
            
            // 연속된 줄바꿈 정리 (최대 2개까지만 허용)
            result = result.replace(/\n{3,}/g, '\n\n');
            
            // 앞뒤 공백 제거
            result = result.trim();
            
            return result;
        }
        
        // 페이지 로드 시 스크립트 포맷팅 적용
        function applyScriptFormatting() {
            const scriptTextarea = document.getElementById('script-textarea');
            if (scriptTextarea) {
                const originalText = scriptTextarea.value;
                if (!originalText) return;
                
                // 줄바꿈이 거의 없거나 타임스탬프가 연속으로 나오는 경우 포맷팅
                const lineBreakCount = (originalText.match(/\n/g) || []).length;
                const timestampCount = (originalText.match(/\[\d{2}:\d{2}\]/g) || []).length;
                
                // 줄바꿈이 타임스탬프 개수의 30% 미만이면 포맷팅 적용
                if (timestampCount > 0 && lineBreakCount < timestampCount * 0.3) {
                    const formattedText = formatScriptWithTimestamps(originalText);
                    if (formattedText !== originalText) {
                        scriptTextarea.value = formattedText;
                    }
                }
            }
        }
        
        // DOMContentLoaded와 window.onload 둘 다 시도
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', applyScriptFormatting);
        } else {
            // DOM이 이미 로드된 경우 즉시 실행
            applyScriptFormatting();
        }
        
        // PDF.js 설정
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        const pdfUrl = "{{ lecture.pdf_file.url }}";
        const pdfContainer = document.getElementById('pdf-container');
        const scale = 1.5;
        
        // PDF 로드 및 모든 페이지 렌더링
        pdfjsLib.getDocument(pdfUrl).promise.then(function(pdfDoc) {
            const numPages = pdfDoc.numPages;
            
            // 로딩 메시지 제거
            pdfContainer.innerHTML = '';
            
            // 모든 페이지를 순차적으로 렌더링하는 함수
            function renderAllPages() {
                const renderPromises = [];
                
                // 모든 페이지 렌더링 작업을 배열에 저장
                for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                    renderPromises.push(
                        pdfDoc.getPage(pageNum).then(function(page) {
                            return new Promise(function(resolve) {
                                // 페이지 래퍼 생성
                                const pageWrapper = document.createElement('div');
                                pageWrapper.className = 'pdf-page-wrapper';
                                pageWrapper.id = `pdf-page-${pageNum}`;
                                
                                // Canvas 생성
                                const canvas = document.createElement('canvas');
                                const ctx = canvas.getContext('2d');
                                
                                // 뷰포트 계산
                                const viewport = page.getViewport({scale: scale});
                                canvas.height = viewport.height;
                                canvas.width = viewport.width;
                                
                                // 페이지 번호 표시 (왼쪽에 배치, 숫자만)
                                const pageNumber = document.createElement('div');
                                pageNumber.className = 'pdf-page-number';
                                pageNumber.textContent = pageNum;
                                
                                // 렌더링
                                const renderContext = {
                                    canvasContext: ctx,
                                    viewport: viewport
                                };
                                
                                page.render(renderContext).promise.then(function() {
                                    // 페이지 번호를 먼저 추가 (왼쪽)
                                    pageWrapper.appendChild(pageNumber);
                                    // 그 다음 canvas 추가 (오른쪽)
                                    pageWrapper.appendChild(canvas);
                                    resolve({pageNum: pageNum, element: pageWrapper});
                                });
                            });
                        })
                    );
                }
                
                // 모든 페이지가 렌더링된 후 순서대로 추가
                Promise.all(renderPromises).then(function(pages) {
                    // 페이지 번호 순으로 정렬
                    pages.sort(function(a, b) {
                        return a.pageNum - b.pageNum;
                    });
                    
                    // 순서대로 DOM에 추가
                    pages.forEach(function(page) {
                        pdfContainer.appendChild(page.element);
                    });
                });
            }
            
            renderAllPages();
        }).catch(function(error) {
            console.error('PDF 로드 오류:', error);
            pdfContainer.innerHTML = 
                '<div class="alert alert-danger m-3" role="alert">PDF를 로드할 수 없습니다. <a href="' + pdfUrl + '" target="_blank" class="alert-link">여기를 클릭하여 새 창에서 열기</a></div>';
        });
    </script>

    <script>
        // 다운로드 링크 클릭 시 파일 다운로드 처리
        document.addEventListener('DOMContentLoaded', function() {
            const downloadLinks = document.querySelectorAll('.download-link-inner');
            
            downloadLinks.forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault(); // 기본 링크 동작(페이지 이동) 방지
                    
                    const downloadUrl = this.href;
                    const downloadType = this.dataset.downloadType;
                    
                    // fetch로 파일 다운로드
                    fetch(downloadUrl)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('다운로드 실패');
                            }
                            
                            // Content-Disposition 헤더에서 파일명 추출 시도
                            const contentDisposition = response.headers.get('Content-Disposition');
                            let filename = null;
                            
                            if (contentDisposition) {
                                // filename*=UTF-8'' 형식 처리
                                const utf8Match = contentDisposition.match(/filename\*=UTF-8''(.+)/i);
                                if (utf8Match) {
                                    filename = decodeURIComponent(utf8Match[1]);
                                } else {
                                    // 일반 filename= 형식 처리
                                    const filenameMatch = contentDisposition.match(/filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/);
                                    if (filenameMatch && filenameMatch[1]) {
                                        filename = filenameMatch[1].replace(/['"]/g, '');
                                    }
                                }
                            }
                            
                            // 파일명이 없으면 기본값 사용
                            if (!filename) {
                                filename = downloadType === 'summary' ? 'summary.txt' : 'script.txt';
                            }
                            
                            return response.blob().then(blob => ({ blob, filename }));
                        })
                        .then(({ blob, filename }) => {
                            // Blob URL 생성
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            
                            // 다운로드 트리거
                            document.body.appendChild(a);
                            a.click();
                            document.body.removeChild(a);
                            
                            // Blob URL 해제
                            window.URL.revokeObjectURL(url);
                        })
                        .catch(error => {
                            console.error('다운로드 오류:', error);
                            alert('파일 다운로드 중 오류가 발생했습니다.');
                        });
                });
            });
        });
    </script>

    <script>
        // 공유 링크 복사 기능
        document.addEventListener('DOMContentLoaded', function() {
            const shareLinkBtn = document.getElementById('share-link-btn');
            
            if (shareLinkBtn) {
                shareLinkBtn.addEventListener('click', function() {
                    // 현재 페이지의 전체 URL 가져오기
                    const currentUrl = window.location.href;
                    
                    // 클립보드에 복사
                    navigator.clipboard.writeText(currentUrl).then(function() {
                        // 복사 성공 시 피드백
                        const originalText = shareLinkBtn.innerHTML;
                        shareLinkBtn.innerHTML = '<i class="bi bi-check-circle"></i> 링크가 복사되었습니다!';
                        shareLinkBtn.classList.remove('btn-light');
                        shareLinkBtn.classList.add('btn-success');
                        
                        // 2초 후 원래 상태로 복원
                        setTimeout(function() {
                            shareLinkBtn.innerHTML = originalText;
                            shareLinkBtn.classList.remove('btn-success');
                            shareLinkBtn.classList.add('btn-light');
                        }, 2000);
                    }).catch(function(err) {
                        // 복사 실패 시 (구형 브라우저 대응)
                        console.error('클립보드 복사 실패:', err);
                        
                        // 대체 방법: 텍스트 영역을 사용한 복사
                        const textArea = document.createElement('textarea');
                        textArea.value = currentUrl;
                        textArea.style.position = 'fixed';
                        textArea.style.opacity = '0';
                        document.body.appendChild(textArea);
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            const originalText = shareLinkBtn.innerHTML;
                            shareLinkBtn.innerHTML = '<i class="bi bi-check-circle"></i> 링크가 복사되었습니다!';
                            shareLinkBtn.classList.remove('btn-light');
                            shareLinkBtn.classList.add('btn-success');
                            
                            setTimeout(function() {
                                shareLinkBtn.innerHTML = originalText;
                                shareLinkBtn.classList.remove('btn-success');
                                shareLinkBtn.classList.add('btn-light');
                            }, 2000);
                        } catch (err) {
                            alert('링크 복사에 실패했습니다. 수동으로 복사해주세요: ' + currentUrl);
                        }
                        
                        document.body.removeChild(textArea);
                    });
                });
            }
        });
    </script>

    <script>
        // 박스 접기/펴기 기능
        document.addEventListener('DOMContentLoaded', function() {
            // Lecture note 접기/펴기
            const toggleLectureNote = document.getElementById('toggle-lecture-note');
            const lectureNoteColumn = document.getElementById('lecture-note-column');
            
            if (toggleLectureNote) {
                toggleLectureNote.addEventListener('click', function(e) {
                    e.stopPropagation();
                    lectureNoteColumn.classList.toggle('collapsed');
                    toggleLectureNote.classList.toggle('collapsed');
                });
                
                // 접힌 상태에서 헤더 클릭 시 다시 펼치기
                lectureNoteColumn.addEventListener('click', function(e) {
                    if (lectureNoteColumn.classList.contains('collapsed') && !e.target.closest('.collapse-toggle-btn')) {
                        lectureNoteColumn.classList.remove('collapsed');
                        toggleLectureNote.classList.remove('collapsed');
                    }
                });
            }
            
            // Summary 접기/펴기
            const toggleSummary = document.getElementById('toggle-summary');
            const summaryColumn = document.getElementById('summary-column');
            
            if (toggleSummary) {
                toggleSummary.addEventListener('click', function(e) {
                    e.stopPropagation();
                    summaryColumn.classList.toggle('collapsed');
                    toggleSummary.classList.toggle('collapsed');
                });
                
                // 접힌 상태에서 헤더 클릭 시 다시 펼치기
                summaryColumn.addEventListener('click', function(e) {
                    if (summaryColumn.classList.contains('collapsed') && !e.target.closest('.collapse-toggle-btn')) {
                        summaryColumn.classList.remove('collapsed');
                        toggleSummary.classList.remove('collapsed');
                    }
                });
            }
        });
    </script>

    <script>
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatContainer = document.getElementById('chat-container');
        const lectureId = parseInt(chatForm.dataset.lectureId);
        
        // localStorage 키 생성
        const chatStorageKey = `chat_history_${lectureId}`;
        
        // 채팅 기록 저장 함수
        function saveChatHistory() {
            const messages = [];
            chatContainer.querySelectorAll('.chat-message').forEach(msg => {
                const isUser = msg.classList.contains('user');
                const content = msg.innerHTML;
                messages.push({
                    type: isUser ? 'user' : 'assistant',
                    content: content
                });
            });
            localStorage.setItem(chatStorageKey, JSON.stringify(messages));
        }
        
        // 채팅 기록 불러오기 함수
        function loadChatHistory() {
            const saved = localStorage.getItem(chatStorageKey);
            if (saved) {
                try {
                    const messages = JSON.parse(saved);
                    messages.forEach(msg => {
                        const messageDiv = document.createElement('div');
                        messageDiv.className = `chat-message ${msg.type}`;
                        messageDiv.innerHTML = msg.content;
                        chatContainer.appendChild(messageDiv);
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } catch (e) {
                    console.error('채팅 기록 로드 오류:', e);
                }
            }
        }
        
        // 페이지 로드 시 채팅 기록 불러오기
        loadChatHistory();

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // RAG 입력이 비활성화된 경우 (소유자가 아닌 경우) 제출 방지
            if (chatInput.disabled) {
                return;
            }
            
            const userMessage = chatInput.value;
            if (!userMessage) return;

            // 1. 사용자 메시지 UI에 표시
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user';
            userMessageDiv.innerHTML = userMessage;
            chatContainer.appendChild(userMessageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // 사용자 메시지 저장
            saveChatHistory();
            
            chatInput.value = '';
            chatInput.disabled = true;

            // 2. 로딩 표시
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'chat-message assistant';
            loadingDiv.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> 답변을 생성하는 중...';
            chatContainer.appendChild(loadingDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                // 3. Django API에 Fetch 요청
                const response = await fetch("{% url 'api_chat' %}", {
                    method: 'POST',
                    body: JSON.stringify({
                        'lecture_id': lectureId,
                        'query_text': userMessage
                    }),
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                // 4. 로딩 메시지 제거
                loadingDiv.remove();

                // 5. AI 답변 UI에 표시 (마크다운 렌더링)
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'chat-message assistant';
                
                // 마크다운을 HTML로 변환
                const markdownContent = marked.parse(data.content);
                
                aiMessageDiv.innerHTML = `<div class="markdown-content">${markdownContent}</div>`;
                chatContainer.appendChild(aiMessageDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
                
                // AI 답변 저장
                saveChatHistory();
            } catch (error) {
                loadingDiv.remove();
                const errorDiv = document.createElement('div');
                errorDiv.className = 'chat-message assistant';
                errorDiv.innerHTML = `<div class="markdown-content">오류: ${error.message}</div>`;
                chatContainer.appendChild(errorDiv);
                saveChatHistory();
            } finally {
                chatInput.disabled = false;
                chatInput.focus();
            }
        });
    </script>
</body>
</html>
